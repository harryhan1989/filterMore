/*
 * 功能：    拓展String类型方法，添加常用功能
 * 创建人：  焰尾迭
 * 创建时间：2015-11-18
 * 最后修改人：  HARRY HAN
 * 最后修改时间：  2016-10-04
 */
$.extend(String.prototype,{format:function(e){var t=this;if(arguments.length>0)if(1==arguments.length&&"object"==typeof e){for(var s in e)if(void 0!=e[s]){var a=new RegExp("({"+s+"})","g");t=t.replace(a,e[s])}}else for(var i=0;i<arguments.length;i++)if(void 0!=arguments[i]){var a=new RegExp("({)"+i+"(})","g");t=t.replace(a,arguments[i])}return t}}),function(e){e.fn.extend({fiterMore:function(t){function s(){var t="";e(b.searchBoxs).each(function(e,s){t+='<div class="searchbox-item" {0} data-id="{1}" id="{2}">'.format(e+1==b.searchBoxs.length?'style="border: 0"':"",e,s.id)+'<div class="l" id="{1}_l">{0}<i></i></div>'.format(s.title,s.id)+'<div class="c" id="{0}_c">'.format(s.id)+'<div class="control-type">({0})</div><div class="filter_option" style="padding-right:{1}px;">'.format(s.tip?s.tip:s.isMultiple?"多选":"单选",n(s)+20)+c(s)+"</div>"+l(e,s)+"</div>"+'<a href="javascript:;" class="r" id="{0}_r"><span class="text">展开</span></a>'.format(s.id)+"</div>"}),y.html(t),e(".searchbox .searchbox-item").each(function(t){var s=e(this).find(".filter_option").outerHeight();s<=30&&e(this).find(".r").remove()}),e(b.searchBoxs).each(function(e,t){o(e,t)}),b.expandRow<b.searchBoxs.length&&y.after(w)}function a(){var t=!0;e(b.searchBoxs).each(function(e,s){if(t=i(s),!t)return!1}),t&&"function"==typeof b.search&&b.search(f())}function i(t){if(t.custom){var s,a=e("#{0}_c_custom_start".format(t.id)).val();if(t.custom.isRange&&(s=e("#{0}_c_custom_end".format(t.id)).val()),""!=a||""!=s){if("function"==typeof t.custom.event&&!t.custom.event(a,s))return!1;t.customSelectd[0]=a,t.custom.isRange&&(t.customSelectd[1]=s)}}return!0}function n(e){return e.custom?e.custom.isRange?2*e.custom.inputWidth+100+20:e.custom.inputWidth+100:0}function c(t){var s="";(t.isMultiple||!t.isMultiple&&t.isShowAll)&&t.data&&(s='<span title="全部" class="option_all {0}">全部</span>'.format(t.defaults&&0!=t.defaults.length?"":"selected"));var a=h(t),i=_;if(a&&!isNaN(t.expand.max)){var n=parseInt(t.expand.max,10);i=i>n?n:i}return e(t.data).each(function(n,c){a&&1+n>i||(s+='<span title="{0}" data-id="{1}" data-value="{3}" {2}>{0}</span>'.format(c[t.textField],n,e.inArray(c[t.valueField],t.defaults)>=0?"class='selected'":"",c[t.valueField]))}),s}function l(e,t){if(t.custom){var s=t.custom.inputWidth+"px",a=t.data?'<div class="filter_custom right_80" style="width:{0}px;"><span>自定义</span>'.format(n(t)):'<div class="filter_custom marginleft_45" style="width:{0}px;">'.format(n(t));return a+='<span><div id="{0}_c_custom">'.format(t.id),a+='<span><input class="form-control" type="text" id="{0}_c_custom_start" name="start" style="width:{1};"></span>'.format(t.id,s),t.custom.isRange&&(a+="<span>—</span>"+'<span><input class="form-control" type="text" id="{0}_c_custom_end" name="end" {1}></span>'.format(t.id,s?"style='width:{0}'".format(s):"")),a+="</div></span>",a+='<span class="btn_filter_sure" data-id="{0}">确定</span></div>'.format(e)}return""}function o(t,s){if(s.custom)if("function"==typeof s.custom.buildFilter)s.custom.buildFilter(e("#{0}_c_custom".format(s.id)),"#{0}_c_custom_start".format(s.id),"#{0}_c_custom_end".format(s.id));else{var a=s.type?s.type:"number";switch(a){case"date":r(t,s)}}}function r(t,s){var a={format:"yyyy-mm-dd",minViewMode:0,maxViewMode:2,language:"zh-CN",calendarWeeks:!0,autoclose:!0,todayHighlight:!0,toggleActive:!0};s.typeMoreConf?e.extend(a,s.typeMoreConf):"",s.custom.isRange?e("#{0}_c_custom".format(s.id)).addClass("input-daterange").datepicker(a):e("#{0}_c_custom_start".format(s.id)).datepicker(a)}function d(t){return e(t).closest(".searchbox-item").attr("data-id")}function u(e){var t=d(e);return b.searchBoxs[t]}function f(){var t=[],s=null;return e(b.searchBoxs).each(function(e,a){s={},a.customSelectd.length>0?s[b.paramCustomkey]=a.customSelectd:s[b.paramkey]=a.selected,s.isMultiple=a.isMultiple,s.id=a.srcID,t.push(s)}),t}function h(e){return e.expand&&"function"==typeof e.expand.event}function p(t,s,a){function i(t){var s=e(t).find(".text");return"展开"==s.text()?"expand":"collaspe"}t.cancelBubble=!0;var n=i(s);if(!a||a!=n){var c=e(s).siblings(".c");if("expand"==n?(e(s).find(".text").text("收缩"),e(s).siblings(".c").css({height:"auto"})):(e(s).find(".text").text("展开"),c.css({height:30})),"展开条件"==w.find("span").text()){var l=0,o=0;e(".searchbox-item").each(function(t,s){"收缩"==e(s).find(".text").text()&&(l++,o+=e(s).find(".c").height())});var r=40*(b.expandRow-l)+9*l+o;0==l&&(r=S),y.css({height:r})}var d=u(s);h(d)&&d.expand.event(d.data,s,n)}}function m(t){t.custom&&t.customSelectd.length>0&&(t.customSelectd=[],e("#{0}_c_custom_start".format(t.id)).val(""),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(""))}function v(t){t.custom&&t.customSelectd.length>0&&(e("#{0}_c_custom_start".format(t.id)).val(t.customSelectd[0]),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(t.customSelectd[1]))}function x(t){function s(e,t){if(0==t.defaults.length)e.filter(".option_all").addClass("selected");else for(var s=0;s<t.defaults.length;s++)e.filter("[data-value='{0}']".format(t.defaults[s])).addClass("selected"),t.selected.push(t.defaults[s])}if(e.isArray(t)){for(var a={},i=null,n=0,c=t.length;n<c;n++)i=t[n],a[i.id]=i;var l;e(b.searchBoxs).each(function(t,n){if(i=a[n.srcID],l=e("#"+n.id).find(".filter_option span"),l.removeClass("selected"),m(n),n.selected=[],i){var c=i[b.paramkey],o=i[b.paramCustomkey];if(c&&c.length>0)for(var t=0;t<c.length&&(l.filter("[data-value='{0}']".format(c[t])).addClass("selected"),n.selected.push(c[t]),n.isMultiple);t++);else if(o&&o.length>0){for(var t=0;t<o.length;t++)n.customSelectd.push(o[t]);v(n)}else s(l,n)}else s(l,n)})}}var _=10,g="searchitem_",y=this,C={expandEvent:function(e){},expandRow:2,searchBoxs:[],search:function(e){},paramkey:"ValueList",paramCustomkey:"CustomList",searchOnSelect:!0},F={isRange:!1,inputWidth:110},b=e.extend(C,t),w=e(b.searchOnSelect?'<div class="filter_btn"><span class="expand">展开条件</span></div>':'<div class="filter_btn"><span class="expand">展开条件</span><span class="search">搜索</span></div>');if(isNaN(b.expandRow)||b.expandRow<1)throw Error("默认展开条件数'expandRow'必须为大于0的整数");b.expandRow>b.searchBoxs.length&&(b.expandRow=b.searchBoxs.length);var S=40*b.expandRow-1*(b.expandRow-1);return y.css({height:S}),e(b.searchBoxs).each(function(t,s){s.id&&"string"==typeof s.id?(s.srcID=s.id,s.id="{0}{1}".format(g,s.id)):(s.srcID=t,s.id="{0}{1}".format(g,t)),s.valueField||s.textField?(s.valueField&&!s.textField&&(s.textField=s.valueField),s.textField&&!s.valueField&&(s.valueField=s.textField)):(s.valueField="value",s.textField="text"),s.defaults||(s.defaults=[]),s.selected=[];for(var a=0;a<s.defaults.length;a++)s.selected.push(s.defaults[a]);s.customSelectd=[],s.custom&&(s.custom=e.extend({},F,s.custom)),void 0==s.isMultiple&&(s.isMultiple=!1),void 0==s.isShowAll&&(s.isShowAll=!0)}),s(),y.on("click select",".filter_option span",function(t){var s=u(this),a=e(this).attr("data-id"),i="select";if(0==s.isMultiple||e(this).hasClass("option_all"))e(this).addClass("selected").siblings("span").removeClass("selected"),s.selected=[],e(this).hasClass("option_all")?i="cancelall":(s.selected.push(s.data[a][s.valueField]),i="selectremove");else if(e(this).hasClass("selected")){e(this).removeClass("selected"),i="cancel";for(var n=s.data[a][s.valueField],c=0,l=s.selected.length;c<l;c++)s.selected[c]==n&&s.selected.splice(c,1);0==s.selected.length&&(e(this).siblings(".option_all").addClass("selected"),i="cancelall")}else e(this).addClass("selected"),e(this).siblings(".option_all").removeClass("selected"),s.selected.push(s.data[a][s.valueField]),i="select";m(s),"function"==typeof s.onSelect&&"click"==t.type&&s.onSelect(s.data[a],i),"function"==typeof b.search&&b.searchOnSelect&&b.search(f())}),y.on("click",".r",function(e,t){p(e,this,t)}),w.find("span").on("click",function(){var t=!0;e(this).hasClass("search")?a():e(this).hasClass("expand")?(e(this).text("收缩条件").removeClass("expand"),y.css({height:"auto"})):(e(this).text("展开条件").addClass("expand"),y.css({height:S}),t=!1),"function"==typeof b.expandEvent&&b.expandEvent(t)}),y.on("click",".filter_custom .btn_filter_sure",function(){var t=e(this).attr("data-id"),s=b.searchBoxs[t];e(this).closest(".filter_custom").siblings(".filter_option").find("span").removeClass("selected"),s.selected=[];var a=i(s);return a?void("function"==typeof b.search&&b.searchOnSelect&&b.search(f())):a}),y.each(function(){this.getParamList=f,this.setValue=x,this.isFiterMore=!0,this.search=a})},getParamList:function(){var e=this[0];if(e.isFiterMore)return e.getParamList()},search:function(){var e=this[0];if(e.isFiterMore)return e.search()},searchFunctionCall:function(t){if(e.isPlainObject(t)){var s=this[0];if(s.isFiterMore)for(var a in t)return e.isFunction(s[a])?s[a](t[a]):(console.error("查询插件fiterMore不支持“{0}”方法".format(a)),null)}}})}(jQuery);
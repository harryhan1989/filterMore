/*
 * 功能：    拓展String类型方法，添加常用功能
 * 创建人：  焰尾迭
 * 创建时间：2015-11-18
 */
$.extend(String.prototype,{format:function(e){var t=this;if(arguments.length>0)if(1==arguments.length&&"object"==typeof e){for(var s in e)if(void 0!=e[s]){var a=new RegExp("({"+s+"})","g");t=t.replace(a,e[s])}}else for(var i=0;i<arguments.length;i++)if(void 0!=arguments[i]){var a=new RegExp("({)"+i+"(})","g");t=t.replace(a,arguments[i])}return t}}),/*!
 @Name：fiterMore v1.0 互联网风格筛选条件插件
 @Author：焰尾迭
 @Site：http://yanwei.cnblogs.com
 @github: http://aui.github.com/fiterMore
 @License：LGPL
 */
function(e){e.fn.extend({fiterMore:function(t){function s(){var t="";e(C.searchBoxs).each(function(e,s){t+='<div class="searchbox-item" {0} data-id="{1}" id="{2}">'.format(e+1==C.searchBoxs.length?'style="border: 0"':"",e,s.id)+'<div class="l" id="{1}_l">{0}<i></i></div>'.format(s.title,s.id)+'<div class="c" id="{0}_c">'.format(s.id)+'<div class="control-type">({0})</div><div class="filter_option" style="padding-right:{1}px;">'.format(s.isMultiple?"多选":"单选",a(s)+20)+i(s)+"</div>"+n(e,s)+"</div>"+'<a href="javascript:;" class="r" id="{0}_r"><span class="text">展开</span></a>'.format(s.id)+"</div>"}),g.html(t),e(".searchbox .searchbox-item").each(function(t){var s=e(this).find(".filter_option").outerHeight();s<=30&&e(this).find(".r").remove()}),e(C.searchBoxs).each(function(e,t){l(e,t)}),C.expandRow<C.searchBoxs.length&&g.after(_)}function a(e){return e.custom?1==e.custom.isRange?"date"==e.type?320:"datetime"==e.type?440:260:"date"==e.type?200:"datetime"==e.type?260:170:0}function i(t){var s="";(t.isMultiple||!t.isMultiple&&t.isShowAll)&&(s='<span title="全部" class="option_all {0}">全部</span>'.format(t.defaults&&0!=t.defaults.length?"":"selected"));var a=u(t),i=v;if(a&&!isNaN(t.expand.max)){var n=parseInt(t.expand.max,10);i=i>n?n:i}return e(t.data).each(function(n,l){a&&1+n>i||(s+='<span title="{0}" data-id="{1}" data-value="{3}" {2}>{0}</span>'.format(l[t.textField],n,e.inArray(l[t.valueField],t.defaults)>=0?"class='selected'":"",l[t.valueField]))}),s}function n(e,t){if(t.custom){var s=t.custom.inputwidth?t.custom.inputwidth:"100px",i='<div class="filter_custom" style="width:{0}px;"><span>自定义</span>'.format(a(t));return i+='<span><div id="{0}_c_custom">'.format(t.id),i+='<span><input class="form-control" type="text" id="{0}_c_custom_start" name="start" style="width:{1};"></span>'.format(t.id,s),t.custom.isRange&&(i+="<span>—</span>"+'<span><input class="form-control" type="text" id="{0}_c_custom_end" name="end" {1}></span>'.format(t.id,s?"style='width:{0}'".format(s):"")),i+="</div></span>",i+='<span class="btn_filter_sure" data-id="{0}">确定</span></div>'.format(e)}return""}function l(e,t){var s=t.type?t.type:"number";switch(s){case"date":c(e,t)}}function c(t,s){var a={format:"yyyy-mm-dd",minViewMode:1,maxViewMode:1,language:"zh-CN",calendarWeeks:!0,autoclose:!0,todayHighlight:!0,toggleActive:!0};s.typeMoreConf?e.extend(a,s.typeMoreConf):"",s.custom.isRange?e("#{0}_c_custom".format(s.id)).addClass("input-daterange").datepicker(a):e("#{0}_c_custom_start".format(s.id)).datepicker(a)}function o(t){return e(t).closest(".searchbox-item").attr("data-id")}function r(e){var t=o(e);return C.searchBoxs[t]}function d(){var t=[],s=null;return e(C.searchBoxs).each(function(e,a){s={},a.customSelectd.length>0?s[C.paramCustomkey]=a.customSelectd:s[C.paramkey]=a.selected,s.isMultiple=a.isMultiple,s.id=a.srcID,t.push(s)}),t}function u(e){return e.expand&&"function"==typeof e.expand.event}function f(t,s,a){function i(t){var s=e(t).find(".text");return"展开"==s.text()?"expand":"collaspe"}t.cancelBubble=!0;var n=i(s);if(!a||a!=n){var l=e(s).siblings(".c");if("expand"==n?(e(s).find(".text").text("收缩"),e(s).siblings(".c").css({height:"auto"})):(e(s).find(".text").text("展开"),l.css({height:30})),"展开条件"==_.find("span").text()){var c=0,o=0;e(".searchbox-item").each(function(t,s){"收缩"==e(s).find(".text").text()&&(c++,o+=e(s).find(".c").height())});var d=40*(C.expandRow-c)+9*c+o;0==c&&(d=w),g.css({height:d})}var f=r(s);u(f)&&f.expand.event(f.data,s,n)}}function p(t){t.custom&&t.customSelectd.length>0&&(t.customSelectd=[],e("#{0}_c_custom_start".format(t.id)).val(""),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(""))}function h(t){t.custom&&t.customSelectd.length>0&&(e("#{0}_c_custom_start".format(t.id)).val(t.customSelectd[0]),t.custom.isRange&&e("#{0}_c_custom_end".format(t.id)).val(t.customSelectd[1]))}function m(t){function s(e,t){if(0==t.defaults.length)e.filter(".option_all").addClass("selected");else for(var s=0;s<t.defaults.length;s++)e.filter("[data-value='{0}']".format(t.defaults[s])).addClass("selected"),t.selected.push(t.defaults[s])}if(e.isArray(t)){for(var a={},i=null,n=0,l=t.length;n<l;n++)i=t[n],a[i.id]=i;var c;e(C.searchBoxs).each(function(t,n){if(i=a[n.srcID],c=e("#"+n.id).find(".filter_option span"),c.removeClass("selected"),p(n),n.selected=[],i){var l=i[C.paramkey],o=i[C.paramCustomkey];if(l&&l.length>0)for(var t=0;t<l.length&&(c.filter("[data-value='{0}']".format(l[t])).addClass("selected"),n.selected.push(l[t]),n.isMultiple);t++);else if(o&&o.length>0){for(var t=0;t<o.length;t++)n.customSelectd.push(o[t]);h(n)}else s(c,n)}else s(c,n)})}}var v=10,x="searchitem_",g=this,_=e('<div class="filter_btn"><span class="expand">展开条件</span></div>'),y={expandEvent:function(e){},expandRow:2,searchBoxs:[],search:function(e){},paramkey:"ValueList",paramCustomkey:"CustomList",searchOnSelect:!0},C=e.extend(y,t);if(isNaN(C.expandRow)||C.expandRow<1)throw Error("默认展开条件数'expandRow'必须为大于0的整数");C.expandRow>C.searchBoxs.length&&(C.expandRow=C.searchBoxs.length);var w=40*C.expandRow-1*(C.expandRow-1);return g.css({height:w}),e(C.searchBoxs).each(function(e,t){t.id&&"string"==typeof t.id?(t.srcID=t.id,t.id="{0}{1}".format(x,t.id)):(t.srcID=e,t.id="{0}{1}".format(x,e)),t.valueField||t.textField?(t.valueField&&!t.textField&&(t.textField=t.valueField),t.textField&&!t.valueField&&(t.valueField=t.textField)):(t.valueField="value",t.textField="text"),t.defaults||(t.defaults=[]),t.selected=[];for(var s=0;s<t.defaults.length;s++)t.selected.push(t.defaults[s]);t.customSelectd=[],void 0==t.isMultiple&&(t.isMultiple=!1),void 0==t.isShowAll&&(t.isShowAll=!0)}),s(),g.on("click select",".filter_option span",function(t){var s=r(this),a=e(this).attr("data-id"),i="select";if(0==s.isMultiple||e(this).hasClass("option_all"))e(this).addClass("selected").siblings("span").removeClass("selected"),s.selected=[],e(this).hasClass("option_all")?i="cancelall":(s.selected.push(s.data[a][s.valueField]),i="selectremove");else if(e(this).hasClass("selected")){e(this).removeClass("selected"),i="cancel";for(var n=s.data[a][s.valueField],l=0,c=s.selected.length;l<c;l++)s.selected[l]==n&&s.selected.splice(l,1);0==s.selected.length&&(e(this).siblings(".option_all").addClass("selected"),i="cancelall")}else e(this).addClass("selected"),e(this).siblings(".option_all").removeClass("selected"),s.selected.push(s.data[a][s.valueField]),i="select";p(s),"function"==typeof s.onSelect&&"click"==t.type&&s.onSelect(s.data[a],i),"function"==typeof C.search&&C.searchOnSelect&&C.search(d())}),g.on("click",".r",function(e,t){f(e,this,t)}),_.find("span").on("click",function(){var t=!0;e(this).hasClass("expand")?(e(this).text("收缩条件").removeClass("expand"),g.css({height:"auto"})):(e(this).text("展开条件").addClass("expand"),g.css({height:w}),t=!1),"function"==typeof C.expandEvent&&C.expandEvent(t)}),g.on("click",".filter_custom .btn_filter_sure",function(){var t,s=e(this).attr("data-id"),a=C.searchBoxs[s],i=e("#{0}_c_custom_start".format(a.id)).val();a.custom.isRange&&(t=e("#{0}_c_custom_end".format(a.id)).val()),("function"!=typeof a.custom.event||a.custom.event(i,t))&&(e(this).closest(".filter_custom").siblings(".filter_option").find("span").removeClass("selected"),a.selected=[],a.customSelectd[0]=i,a.custom.isRange&&(a.customSelectd[1]=t),"function"==typeof C.search&&C.search(d()))}),g.each(function(){this.getParamList=d,this.setValue=m,this.isFiterMore=!0})},getParamList:function(){var e=this[0];if(e.isFiterMore)return e.getParamList()},searchFunctionCall:function(t){if(e.isPlainObject(t)){var s=this[0];if(s.isFiterMore)for(var a in t)return e.isFunction(s[a])?s[a](t[a]):(console.error("查询插件fiterMore不支持“{0}”方法".format(a)),null)}}})}(jQuery);